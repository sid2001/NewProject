<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Web App</title>
    <link rel="stylesheet" href="css/chat.css">
</head>
<body onload = "connectChat()">
    <div class="menu-closed">

        <!-- Side Menu -->
        <div id="side-menu" class="side-menu">
        </div>
    
        <!-- Content Area -->
        <div id="content">
            <span id="menu-button" onclick="toggleMenu()">&#9776;</span>
        </div>
    
        
    </div>
    <div class="chat-container">
        <div class="video-container">
            <!-- User's video -->
            <div class="video">
                <!-- Replace with actual video element or iframe -->
                <video autoplay></video>
            </div>
            <!-- Recipient's video -->
            <div class="video">
                <!-- Replace with actual video element or iframe -->
                <video autoplay></video>
            </div>
        </div>
        <div class="chat">
            <div class="chat-messages">
                <!-- Chat messages will be displayed here -->
                <div id="message" class="message">
                    <!-- <div class="message-sender">Sender</div>
                    <div class="message-text">Hello!</div> -->
                </div>
                <!-- Add more message divs as needed -->
            </div>
            <div class="message-input">
                <textarea id="message-input" name="message" placeholder="Type your message..."></textarea>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var users = <%- JSON.stringify(users) %>;
    var selectedContact = users[0].username;
    var contacts = document.getElementById("side-menu");
    users.forEach((user)=>{
        let contact = document.createElement('contact');
        contact.innerHTML = user.name;
        contact.addEventListener("click",()=>{
            selectedContact = user.username;
        })
        contact.setAttribute("username",user.username);
        contacts.appendChild(contact);
    })
    function toggleMenu() {
        var sideMenu = document.getElementById("side-menu");
        var content = document.getElementById("content");
        var body = document.body;

        if (sideMenu.style.width === "250px") {
            sideMenu.style.width = "0";
            content.style.marginLeft = "0";
            body.classList.remove("menu-open");
        } else {
            sideMenu.style.width = "250px";
            content.style.marginLeft = "250px";
            body.classList.add("menu-open");
        }
    }
</script>
<script>

    var inputArea = document.getElementById("message-input");
    var sendButton = document.getElementById("send-button");
    sendButton.addEventListener("click",sendMessage);
    var ws;
    async function connectChat(){
    ws = await new WebSocket('ws://localhost:3000/chat');
    ws.onerror = (error)=>console.error;
    ws.onopen = open;
    ws.onmessage = gotMessage;
    }
    function open(){
        console.log("Connection Established!!");
    }

    function gotMessage(dat){
        console.log(dat.data);
        const parsedData = JSON.parse(dat.data.toString("utf8"));
        //if sent data is a text message from the user then display the message.
        if(parsedData.type=='text'){
            var currentMessage = document.getElementById("message");
            var messageSender = document.createElement('div');
            messageSender.class = "message-sender";
            messageSender.innerHTML = parsedData.from;
            var message = document.createElement("div");
            message.class = "message";
            message.innerHTML = parsedData.message; 
            currentMessage.appendChild(messageSender);
            currentMessage.appendChild(message);
        }
    }
    async function sendMessage(){
        const data = {
            type:"text",
            message: inputArea.value,
            from:selectedContact
        }
        try{
        if(ws.readyState===3) await connectChat();
        ws.send(JSON.stringify(data));
        inputArea.value = "";
        }
        catch{
            console.log("Couldn't send message!!");
        }
    }
</script>
</html>
